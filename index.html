<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Herramienta Corte de Procesos</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:"Segoe UI",Roboto,Arial,sans-serif}
  body{display:flex;height:100vh;background:linear-gradient(145deg,#f8f8f8 40%,#e9eef3);color:#222}

  /* SIDEBAR */
  .sidebar{
    width:300px;min-width:260px;
    background:linear-gradient(180deg,#b30000 0%,#cc0000 100%);
    color:#fff;padding:18px;display:flex;flex-direction:column;gap:10px;
    box-shadow:3px 0 12px rgba(0,0,0,.18);
  }
  .brand{text-align:center;padding:8px 0 14px;border-bottom:1px solid rgba(255,255,255,.06)}
  .brand h2{font-size:16px;letter-spacing:.6px;margin-bottom:6px}
  .menu{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .menu button{
    background:transparent;border:1px solid rgba(255,255,255,.08);
    color:#fff;padding:10px;border-radius:8px;cursor:pointer;text-align:left;font-weight:600;
    display:flex;align-items:center;gap:8px;transition:.15s;
  }
  .menu button.active{background:#fff;color:#b30000;border-color:rgba(0,0,0,.06)}
  .menu button:hover{background:rgba(255,255,255,.06)}
  footer.smallfoot{color:rgba(255,255,255,.7);font-size:12px;text-align:center;margin-top:10px}

  /* MAIN */
  .main{flex:1;padding:20px;overflow:auto}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  .title{font-size:1.4rem;color:#b30000;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,.08)}
  .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.06);margin-bottom:18px}

  .upload{border:2px dashed #007bff;background:#f0f8ff;padding:12px;border-radius:10px;text-align:center;margin-bottom:12px}
  input[type=file]{margin-top:8px}

  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #e6e9ef;padding:8px;text-align:left;font-size:13px}
  th{background:#007bff;color:#fff}
  .muted{color:#666;font-size:13px}
  .count-badge{color:#b30000;font-weight:800;font-size:18px}

  /* Informe cards */
  .report-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .report-card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 12px rgba(0,0,0,.06)}
  .report-card h4{margin-bottom:8px;color:#0056b3}
  .small{font-size:13px;color:#555}

  @media (max-width:900px){
    .sidebar{display:none}
    body{flex-direction:column}
    .main{padding:12px}
    .report-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <h2>Herramienta Corte de Procesos FROGMI</h2>
      <div class="muted">Panel lateral de control</div>
    </div>

    <nav class="menu">
      <button id="btnPickings" class="active" onclick="mostrarBloque('pickings', this)">üì¶ Pickings</button>
      <button id="btnTraspasos" onclick="mostrarBloque('traspasos', this)">üîÅ Traspasos</button>
      <button id="btnInforme" onclick="generarInforme()">üìä Informe General</button>
    </nav>

    <footer class="smallfoot">¬© 2025 FJCR24102025</footer>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="header">
      <div class="title" id="tituloPrincipal">Herramienta Corte de Procesos</div>
    </div>

    <!-- PICKINGS -->
    <section id="pickings" class="card">
      <h3 style="color:#0056b3;text-align:center;margin-bottom:12px">Comparativo de Pickings</h3>

      <div class="upload">
        <strong>üìò Cargar Excel ZVA05VTAS (layout NORMAL)</strong><br>
        <input type="file" id="inputExcel1" accept=".xlsx,.xls">
      </div>

      <div class="upload">
        <strong>üìó Cargar Excel VL06O KUMO (layout NORMAL2)</strong><br>
        <input type="file" id="inputExcel2" accept=".xlsx,.xls">
      </div>

      <div id="pickingsSummary" style="margin-top:10px;display:none">
        <table id="tablePickings">
          <thead><tr><th>Categor√≠a</th><th>ZVA05VTAS</th><th>VL06O KUMO</th><th>Total</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="pickingsResult" class="muted" style="margin-top:8px"></div>
    </section>

    <!-- TRASPASOS -->
    <section id="traspasos" class="card" style="display:none">
      <h3 style="color:#0056b3;text-align:center;margin-bottom:12px">Traspasos ‚Äî resumen</h3>

      <div class="upload">
        <strong>üìò Cargar Excel 1 ‚Äî No surtidos por centro suministrador</strong><br>
        <input type="file" id="fileTraspaso1" accept=".xlsx,.xls">
      </div>

      <div class="upload">
        <strong>üìó Cargar Excel 2 ‚Äî Sin entrada material con salida</strong><br>
        <input type="file" id="fileTraspaso2" accept=".xlsx,.xls">
      </div>

      <div id="traspasosTableWrap" style="margin-top:12px;display:none">
        <table id="tableTraspasos">
          <thead><tr><th>Concepto</th><th>Cantidad No surtida</th><th>Sin entrada</th><th>Total</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="traspasosNote" class="muted" style="margin-top:10px"></div>
    </section>

    <!-- INFORME -->
    <section id="informe" style="display:none" class="card">
      <h3 style="color:#0056b3;text-align:center;margin-bottom:12px">Informe General</h3>
      <div class="report-grid" id="reportGrid">
        <!-- tarjetas generadas por JS -->
      </div>
      <div style="margin-top:12px;font-weight:bold;color:#b30000">
        üëâ Dar seguimiento a los procesos y concluirlos con la debida validaci√≥n.
      </div>
    </section>

  </main>

<script>
  // Vistas
  function mostrarBloque(id, btn){
    document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    document.getElementById('pickings').style.display = id==='pickings' ? 'block' : 'none';
    document.getElementById('traspasos').style.display = id==='traspasos' ? 'block' : 'none';
    document.getElementById('informe').style.display = id==='informe' ? 'block' : 'none';
    document.getElementById('tituloPrincipal').textContent =
      id==='pickings' ? 'Comparativo Pickings / Orden de Compra' :
      id==='traspasos' ? 'Gesti√≥n / Reporte de Traspasos' : 'Informe General';
  }

  // Datos globales
  let pick1 = [], pick2 = [];
  let trA = [], trB = [];
  // res√∫menes pickings
  let resumenPick1 = {con:0,sin:0,total:0,entregaInmediata:0};
  let resumenPick2 = {con:0,sin:0,total:0,entregaInmediata:0};

  // --- PICKINGS: carga y c√°lculo ---
  document.getElementById('inputExcel1').addEventListener('change', e => procesarPick(e,1));
  document.getElementById('inputExcel2').addEventListener('change', e => procesarPick(e,2));

  function procesarPick(evt, tipo){
    const file = evt.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data,{type:'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet,{defval:""});
      if(tipo===1) pick1 = json; else pick2 = json;
      calcularResumenPick(tipo);
      renderPickingsTable();
    };
    reader.readAsArrayBuffer(file);
  }

  function calcularResumenPick(tipo){
    const arr = tipo===1 ? pick1 : pick2;
    let con=0, sin=0, entregaInmediata=0;
    arr.forEach(row=>{
      // detectar columnas "Orden de Compra" y "Solicitud de Traspaso" (si existen)
      const oc = Number(row["Orden de Compra"]) || 0;
      const tr = Number(row["Solicitud de Traspaso"]) || 0;
      const suma = oc + tr;
      if(suma > 0) con++; else sin++;
      // buscar texto ENTREGA INMEDIATA en cualquier campo
      for(let k in row){
        const v = (row[k]||"").toString().toUpperCase();
        if(v.includes("ENTREGA INMEDIATA")){ entregaInmediata++; break; }
      }
    });
    const obj = {con, sin, total: con+sin, entregaInmediata};
    if(tipo===1) resumenPick1 = obj; else resumenPick2 = obj;
    document.getElementById('pickingsResult').innerText = 'Pickings procesados ‚úì';
  }

  function renderPickingsTable(){
    const tableWrap = document.getElementById('pickingsSummary');
    const tbody = document.querySelector('#tablePickings tbody');
    const totalCon = resumenPick1.con + resumenPick2.con;
    const totalSin = resumenPick1.sin + resumenPick2.sin;
    const totalEnt = resumenPick1.entregaInmediata + resumenPick2.entregaInmediata;
    if(resumenPick1.total>0 || resumenPick2.total>0){
      tableWrap.style.display='block';
      tbody.innerHTML = `
        <tr><td>Con "Traspaso o OC"</td><td>${resumenPick1.con}</td><td>${resumenPick2.con}</td><td>${totalCon}</td></tr>
        <tr><td>Sin "Traspaso o OC"</td><td>${resumenPick1.sin}</td><td>${resumenPick2.sin}</td><td>${totalSin}</td></tr>
        <tr><td>ENTREGA INMEDIATA</td><td>${resumenPick1.entregaInmediata}</td><td>${resumenPick2.entregaInmediata}</td><td>${totalEnt}</td></tr>
      `;
    } else {
      tableWrap.style.display='none';
      tbody.innerHTML = '';
    }
  }

  // --- TRASPASOS: carga y resumen en tabla simple ---
  document.getElementById('fileTraspaso1').addEventListener('change', e => cargarTraspaso(e,'A'));
  document.getElementById('fileTraspaso2').addEventListener('change', e => cargarTraspaso(e,'B'));

  function cargarTraspaso(e, which){
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      const data = new Uint8Array(evt.target.result);
      const wb = XLSX.read(data,{type:'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet,{defval:""});
      if(which==='A') trA = json; else trB = json;
      procesarTraspasos();
    };
    reader.readAsArrayBuffer(file);
  }

  function procesarTraspasos(){
    // contadores b√°sicos
    const totalA = trA.length;
    const totalB = trB.length;

    // solicitudes √∫nicas por archivo
    const setA = new Set(), setB = new Set();
    trA.forEach(r=>{ const k = (r["Solicitud de Traspaso"]||"").toString().trim(); if(k) setA.add(k); });
    trB.forEach(r=>{ const k = (r["Solicitud de Traspaso"]||"").toString().trim(); if(k) setB.add(k); });

    const uniqueA = setA.size;
    const uniqueB = setB.size;

    // coincidencias (intersecci√≥n)
    const common = [...setA].filter(x => setB.has(x));

    // tipos de entrega (contar por valor de columna "Tipo de Entrega" si existe)
    const tipos = {};
    [...trA,...trB].forEach(r=>{
      const t = ((r["Tipo de Entrega"]||r["TipoEntrega"]||"") + "").toString().trim() || "VAC√çO";
      tipos[t] = (tipos[t]||0) + 1;
    });

    // render tabla simple
    document.getElementById('traspasosTableWrap').style.display = 'block';
    const tbody = document.querySelector('#tableTraspasos tbody');
    tbody.innerHTML = `
      <tr><td>Total renglones "Por SKU¬¥s"</td><td>${totalA}</td><td>${totalB}</td><td>${totalA+totalB}</td></tr>
      <tr><td>Solicitudes √∫nicas</td><td>${uniqueA}</td><td>${uniqueB}</td><td>${uniqueA+uniqueB}</td></tr>
      <tr><td>Coincidencias (solicitudes en ambos)</td><td colspan="3">${common.length}</td></tr>
    `;
    // nota con tipos de entrega resumidos
    const tiposList = Object.entries(tipos).map(t=>`${t[0]}: ${t[1]}`).join(' ¬∑ ');
    document.getElementById('traspasosNote').innerText = tiposList ? 'Tipos de entrega: ' + tiposList : 'No se detectaron valores en "Tipo de Entrega".';
  }

  // --- INFORME REDISE√ëADO (sin pedidos listados) ---
  function generarInforme(){
    // preparar datos
    const totalPick1 = resumenPick1.total || 0;
    const totalPick2 = resumenPick2.total || 0;
    const totalPickAll = totalPick1 + totalPick2;

    const totalTrA = trA.length;
    const totalTrB = trB.length;

    // tipos de entrega para mostrar (preparado en procesarTraspasos, pero recalculamos aqu√≠ por si no se hizo)
    const tipos = {};
    [...trA,...trB].forEach(r=>{
      const t = ((r["Tipo de Entrega"]||r["TipoEntrega"]||"") + "").toString().trim() || "VAC√çO";
      tipos[t] = (tipos[t]||0) + 1;
    });

    // motivos en pickings (si existen) - resumen corto: top 5 motivos por frecuencia
    const motivos = {};
    [pick1,pick2].forEach(arr=>{
      arr.forEach(r=>{
        for(let k in r){
          const v = (r[k]||"").toString().trim();
          if(!v) continue;
          const up = v.toUpperCase();
          // heur√≠stica: buscar palabras clave que indiquen motivo
          if(up.includes('MOTIVO') || up.includes('RAZ√ìN') || up.includes('RAZON') || up.includes('FALTA') || up.includes('ERROR')){
            motivos[v] = (motivos[v]||0) + 1;
          }
        }
      });
    });
    const motivosSorted = Object.entries(motivos).sort((a,b)=>b[1]-a[1]).slice(0,5);

    // render del informe
    mostrarBloque('informe', document.getElementById('btnInforme'));
    const grid = document.getElementById('reportGrid');
    grid.innerHTML = '';

    // tarjeta: resumen pickings
    const cardPick = document.createElement('div'); cardPick.className='report-card';
    cardPick.innerHTML = `<h4>Pickings ‚Äî resumen</h4>
      <div class="small">Archivo ZVA05VTAS: ${totalPick1} renglones</div>
      <div class="small">Archivo VL06O KUMO: ${totalPick2} renglones</div>
      <div style="height:8px"></div>
      <div class="small"><strong>Con "Traspaso o OC":</strong> ${resumenPick1.con} (A) ¬∑ ${resumenPick2.con} (B) ¬∑ Total ${resumenPick1.con+resumenPick2.con}</div>
      <div class="small"><strong>Sin "Traspaso o OC":</strong> ${resumenPick1.sin} (A) ¬∑ ${resumenPick2.sin} (B) ¬∑ Total ${resumenPick1.sin+resumenPick2.sin}</div>
      <div class="small"><strong>ENTREGA INMEDIATA:</strong> ${resumenPick1.entregaInmediata + resumenPick2.entregaInmediata}</div>
    `;
    grid.appendChild(cardPick);

    // tarjeta: resumen traspasos (tabla de conteos)
    const cardTr = document.createElement('div'); cardTr.className='report-card';
    let tiposHtml = Object.entries(tipos).map(t=>`<div class="small">${t[0]} ‚Äî ${t[1]}</div>`).join('');
    if(!tiposHtml) tiposHtml = `<div class="small">No hay registros o no se detect√≥ "Tipo de Entrega".</div>`;
    cardTr.innerHTML = `<h4>Traspasos ‚Äî resumen</h4>
      <div class="small">Archivo 1 (No surtidos): ${totalTrA} renglones ‚Äî Solicitudes √∫nicas: ${[...new Set(trA.map(x=> (x["Solicitud de Traspaso"]||"").toString().trim()).filter(Boolean))].length}</div>
      <div class="small">Archivo 2 (Sin entrada): ${totalTrB} renglones ‚Äî Solicitudes √∫nicas: ${[...new Set(trB.map(x=> (x["Solicitud de Traspaso"]||"").toString().trim()).filter(Boolean))].length}</div>
      <div style="height:8px"></div>
      <div class="small"><strong>Coincidencias:</strong> ${[...new Set(trA.map(x=> (x["Solicitud de Traspaso"]||"").toString().trim()))].filter(x=> x && new Set(trB.map(y=> (y["Solicitud de Traspaso"]||"").toString().trim())).has(x)).length}</div>
      <div style="height:6px"></div>
      ${tiposHtml}
    `;
    grid.appendChild(cardTr);

    // tarjeta: observaciones (motivos compactos, sin pedidos)
   // const cardObs = document.createElement('div'); cardObs.className='report-card';
   // cardObs.innerHTML = `<h4>Observaciones</h4>
    //  <div class="small">Se muestran hasta 5 motivos detectados en los archivos (solo si existen campos con la palabra motivo/raz√≥n/falta/error).</div>
    //  <div style="height:8px"></div>
    //  ${motivosSorted.length ? motivosSorted.map(m=>`<div class="small">- ${m[0]} ‚Äî ${m[1]} veces</div>`).join('') : '<div class="small">No se detectaron motivos //relevantes.</div>'}
  //  `;
    grid.appendChild(cardObs);
  }

  // Inicial
  mostrarBloque('pickings', document.getElementById('btnPickings'));
</script>

</body>
</html>

